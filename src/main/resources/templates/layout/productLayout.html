<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <title>롯데ON::3조</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <link rel="shortcut icon" type="image/x-icon" href="../images/favicon.ico" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://kit.fontawesome.com/20962f3e4b.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/bxslider/4.2.12/jquery.bxslider.min.js"></script>
    <link rel="stylesheet" th:href="@{https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css}">
    <link rel="stylesheet" th:href="@{https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css}"/>
    <link rel="stylesheet" th:href="@{https://cdn.jsdelivr.net/bxslider/4.2.12/jquery.bxslider.css}">
    <link rel="stylesheet" th:href="@{/css/common.css}"/>
    <link rel="stylesheet" th:href="@{/css/product.css}">
    <script>
        window.onload= async function (){
            const orgPrice = document.getElementsByClassName('org_price')[0];
            // 할인률
            const discountDel = orgPrice.getElementsByTagName('span')[0];
            const discountText = discountDel.innerText;
            const discountValue = discountText.split('%')[0];
            let intDiscount = parseInt(discountValue);

            // 상품 원가격
            const productPriceSpan = orgPrice.getElementsByTagName('del')[0];
            const productPriceText = productPriceSpan.innerText;
            let intProductPrice = parseInt(productPriceText);

            // 상품의 할인된 가격
            let discountPrice = intProductPrice * ((100-intDiscount)/100);

            //할인된 가격 표시
            const dis_price = document.getElementsByClassName('dis_price')[0];
            const dis_priceIns = dis_price.getElementsByTagName('ins')[0];

            dis_priceIns.innerText = discountPrice;

            // 배송비
            const delivery = document.getElementsByClassName('delivery')[0];
            const deliveryVal = delivery.innerText;
            const deliveryWon = deliveryVal.split(':')[1];
            let deliveryValue = deliveryWon.split('원')[0];
            let deliveryInt = parseInt(deliveryValue);

            // 총 가격 표시 html
            const total = document.getElementsByClassName('total')[0];
            const totalSpan = total.getElementsByTagName('span')[0];

            if (discountPrice>=30000){
                totalSpan.innerText = discountPrice;
            }else if(discountPrice <= 30000) {
                totalSpan.innerText = discountPrice+deliveryInt;
            }

            // 상품 번호
            const prodNoAfter = location.href.split('=')[1];
            const prodNo = prodNoAfter.split('&')[0];

            // 옵션 select 요소
            const selectOption = document.querySelectorAll('.selectOption');
            // 각 옵션 select 요소에 대해 이벤트 등록
            selectOption.forEach(function (select) {

                console.log("select : "+select);

                // 옵션 선택시
                select.addEventListener('change', async function() {
                    var opName = this.value;
                    console.log('opName : ' + opName);
                    console.log('prodNo : ' + prodNo);

                    // 상세 select 선택
                    const nav = select.closest('nav');
                    const selectDetail = nav.querySelector('.selectDetail');

                    await fetch(`/lotteon/cart/opValue/${prodNo}/${opName}`)
                        .then(response => response.json())
                        .then(data=> {


                            console.log(data);
                            data.forEach(function (obj){
                                console.log(obj.opValue);
                                console.log(obj.opNo);

                                const newOption = document.createElement("option");
                                newOption.textContent = obj.opValue;
                                newOption.value = obj.opNo;
                                selectDetail.appendChild(newOption);
                            });
                        })
                        .catch(err=>{
                        console.log(err)});

                    // 상세 select disabled 삭제
                    selectDetail.disabled = false;
                });
            });

            const countDiv = document.getElementsByClassName('count')[0];

            // 상품수량 감소 버튼
            const decrease = countDiv.getElementsByClassName('decrease')[0];
            // 상품수량 중가 버튼
            const increase = countDiv.getElementsByClassName('increase')[0];
            // 상품수량
            const count = countDiv.getElementsByClassName('number')[0];
            count.value = 1;

            const countValueText = count.value;

            let countValue = parseInt(countValueText);

            decrease.addEventListener('click', await function (){
                if (countValue > 1) {
                    countValue = countValue - 1;
                    count.value = countValue;
                    // 30000원 이상 무료배송
                    if (totalPrice >= 30000) {
                        let totalPrice = (discountPrice * count.value);
                        totalSpan.innerText = totalPrice;
                    } else if (totalPrice <= 30000) {
                        let totalPrice = (discountPrice * count.value) + deliveryInt;
                        totalSpan.innerText = totalPrice;
                    }
                }else if(countValue <= 1){
                    alert('최소 구매 수량은 1개 입니다.');
                }


            });


            increase.addEventListener('click', await function (){
                countValue = countValue +1;
                count.value = countValue;

                // 30000원 이상 무료배송
                if(totalPrice>=30000){
                    let totalPrice = (discountPrice*count.value);
                    totalSpan.innerText = totalPrice;
                }else if(totalPrice <= 30000){
                    let totalPrice = (discountPrice*count.value)+deliveryInt;
                    totalSpan.innerText = totalPrice;
                }
            });

            let totalPrice = (discountPrice*countValue)+deliveryInt;
            console.log('totalPrice : ' + totalPrice);

            const uid = document.getElementById('uid')
            let uidValue;

            if(uid){
                uidValue = uid.value;

            }else{
                uidValue = null;
            }
            console.log(uidValue);

            // 장바구니 버튼
            const cart = document.getElementsByClassName('cart')[0];


            cart.onclick = async function (e) {
                e.preventDefault();
                if (uidValue == null) {
                    location.href = `/lotteon/member/login`;
                }else if (confirm("장바구니에 담으시겠습니까?")) {

                    const jsonData = {
                        "prodNo": prodNo,
                        "count": countValue,
                        "uid": uidValue,
                        "opNo": 1
                    };

                    console.log(jsonData);

                    await fetch(`/lotteon/cart/insert`, {
                        method: 'POST',
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify(jsonData)
                    })
                        .then(response => response.json())
                        .then(data => {
                            if(data != null){
                                if(confirm("장바구니로 이동하시겠습니까?")){
                                    location.href= `/lotteon/product/cart`;
                                }
                            }else{
                                alert("등록에 실패했습니다.");
                            }
                        })
                        .catch((err) => {
                            console.log(err);
                        });
                }

            }

        }

    </script>
</head>
<body>
<div id="wrapper">
    <header>
        <div class="top">
            <div>
                <th:block sec:authorize="isAnonymous()">
                    <a th:href="@{/member/login}">로그인</a>
                    <a th:href="@{/member/join}">회원가입</a>
                </th:block>
                <th:block sec:authorize="isAuthenticated()">
                    <span>[[${#authentication.principal.member.name}]]님</span>
                    <a th:href="@{/member/logout}">로그아웃</a>
                    <a th:href="@{/my/home}">마이페이지</a>
                    <a th:href="@{/product/cart}">
                        <i class="fa fa-shopping-cart" aria-hidden="true"></i>&nbsp;장바구니
                    </a>
                </th:block>
            </div>
        </div>
        <div class="logo">
            <div>
                <a th:href="@{/}"><img th:src="@{/images/header_logo.png}" alt="로고" /></a>
                <form th:action="@{#}">
                    <input type="text" name="search"/>
                    <button><i class="fa fa-search"></i></button>
                </form>
            </div>

        </div>
        <div class="menu">
            <div>
                <ul>
                    <li><a th:href="@{/product/list}">히트상품</a></li>
                    <li><a th:href="@{/product/list}">추천상품</a></li>
                    <li><a th:href="@{/product/list}">최신상품</a></li>
                    <li><a th:href="@{/product/list}">인기상품</a></li>
                    <li><a th:href="@{/product/list}">할인상품</a></li>
                </ul>
                <ul>
                    <li><a th:href="@{#}">쿠폰존</a></li>
                    <li><a th:href="@{#}">사용후기</a></li>
                    <li><a th:href="@{#}">개인결제</a></li>
                    <li><a th:href="@{#}">고객센터</a></li>
                    <li><a th:href="@{#}">FAQ</a></li>
                </ul>
            </div>
        </div>
    </header>
    <main id="product">
        <aside>
            <!-- 카테고리 -->
            <ul class="category">
                <li><i class="fa fa-bars" aria-hidden="true"></i>카테고리</li>
                <li th:each="cate1 : ${cate1DTOS}">
                    <a th:href="@{/product/list(cate1=${cate1.cate1})}">
                        <i th:class="'fas fa-' + ${cate1.css}"></i>[[${cate1.c1Name}]]<i class="fas fa-angle-right"></i>
                    </a>
                    <ol>
                        <li th:each="cate2 : ${cate2DTOS}" th:if="${cate2.cate1 == cate1.cate1}">
                            <a th:href="@{/product/list(cate1=${cate2.cate1},cate2=${cate2.cate2})}">[[${cate2.c2Name}]] </a>
                            <ol>
                                <li th:each="cate3 : ${cate3DTOS}" th:if="${cate3.cate2 == cate2.cate2}">
                                    <a th:href="@{/product/list(cate1=${cate2.cate1},cate2=${cate2.cate2},cate3=${cate3.cate3})}">[[${cate3.c3Name}]]</a>
                                </li>
                            </ol>
                        </li>
                    </ol>
                </li>
            </ul>
        </aside>

        <section layout:fragment="content">
            <!-- 내용 -->
        </section>

        </main>
        <footer>
            <ul>
                <li><a th:href="@{company/introduce}">회사소개</a></li>
                <li><a th:href="@{policy/seller}">서비스이용약관</a></li>
                <li><a th:href="@{policy/privacy}">개인정보처리방침</a></li>
                <li><a th:href="@{policy/finance}">전자금융거래약관</a></li>
            </ul>
            <div>
                <p><img src="../images/footer_logo.png" alt="로고" /></p>
                <p>
                    <strong>(주)롯데ON</strong><br />
                    서울특별시 송파구 올림픽로 300 롯데월드타워 26층 (역삼동 강남파이낸스센터)<br />
                    대표이사 : 김사무엘상현, 정준호, 강성현<br />
                    사업자등록번호 : 529-85-00774(롯데쇼핑(주) e커머스사업부)<br />
                    통신판매업 신고 : 서울송파 제0158호<br>
                    호스팅 서비스사업자 : 롯데쇼핑(주) e커머스사업부
                </p>
                <p>
                    <strong>고객센터</strong><br />
                    Tel : 1899-7000(유료) (평일 09:00~18:00)<br />
                    Fax : 051-123-4567 | E-mail : lotteon@lotte.net<br />
                </p>
                <p>
                    <strong>[[${appInfo.name}]]-[[${appInfo.version}]]</strong>
                </p>
            </div>
        </footer>
        <button type="button" id="top">상단이동</button>
</div>
</body>

</html>
