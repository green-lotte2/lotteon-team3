<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout/sellerLayout}">

            <section id="admin-index" layout:fragment="content">
                <script>
                    window.onload = async function (){
                        // 주문 차트
                        let ordCt = document.getElementById('orderChart');

                        // 주문 데이터 가져오기
                        const response = await fetch('/lotteon/seller/orderChart');
                        const dataText = await response.text(); // JSON 형식의 문자열을 가져옴
                        console.log("주문 데이터 dataText : " + dataText);
                        let total = 0;
                        let data = [];

                        // json 파싱
                        try {
                            // JSON 형식의 문자열을 JavaScript 객체로 변환
                            data = JSON.parse(dataText);
                            console.log("주문 데이터 : ", data);

                            // total 값 추출
                            total = data.pop().total;
                            console.log("Total Orders:", total);
                        } catch (error) {
                            console.error('주문 데이터 변환 오류:', error);
                        }
                        // 차트 상단에 출력
                        const ordTotal = document.getElementById('ordTotal');
                        ordTotal.innerText = total;

                        let orderChart = new Chart(ordCt,     {
                            type: 'bar',
                            data: {
                                labels: data.map(row => row.month),
                                datasets: [{
                                        label: '월별 주문 건수',
                                        data: data.map(row => row.count),
                                        backgroundColor: '#848a8e',}]},
                            options: {
                                // 크기 조절을 위해 false
                                responsive: false,
                                title: {
                                    display: true,
                                },
                                scales: {
                                    yAxes: [{
                                        ticks: {
                                            beginAtZero: true,
                                            stepSize: 1
                                        }
                                    }]
                                }
                            }
                        });
                    }
                    // 아코디언 상태 변경
                    function accordionControl(button){
                        // 해당 버튼의 data-bs-target 값을 사용하여 아코디언 컨텐츠 요소 가져오기
                        const targetId = button.getAttribute('data-bs-target');
                        const targetContent = document.getElementById(targetId);

                        // 현재 아코디언 상태 확인
                        const isExpanded = button.getAttribute('aria-expanded') === 'true';

                        if (isExpanded) {
                            // 아코디언 닫기
                            button.setAttribute('aria-expanded', 'false');
                            targetContent.classList.remove('show');
                        } else {
                            // 아코디언 열기
                            button.setAttribute('aria-expanded', 'true');
                            targetContent.classList.add('show');
                        }
                    }
                    // 모달 띄우기
                    function changeStatus(){
                        const modal = document.querySelector(".modal");

                        modal.style.display = "block";
                    }
                    // 모달 끄기
                    function closeModal() {
                        const modal = document.querySelector(".modal");
                        modal.style.display = "none";
                    }
                </script>
                <nav>
                    <h3>관리자 메인</h3>
                    <p>
                        HOME > <strong>메인</strong>
                    </p>
                </nav>
                <article>
                    <table>
                        <tr>
                            <td>
                                <strong>최근 12개월 주문건수(건)</strong>
                                <span id="ordTotal"></span>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <canvas id="orderChart" width="800" height="300" style="margin-left: 140px"></canvas>
                            </td>
                        </tr>
                    </table>
                </article>
                <h4>쇼핑몰 주문현황</h4>
                <th:block th:if="${pageResponseDTO.dtoList.isEmpty()}">
                    <div>
                        <img th:src="@{/admin/images/noproduct.png}" style="width: 900px; height: 460px">
                    </div>
                </th:block>
                <!--<table class="sellerOrderTh">
                    <tbody>
                    <tr th:if="${!pageResponseDTO.dtoList.isEmpty()}">
                        <th>gg</th>
                        <th>gg</th>
                        <th>gg</th>
                        <th>gg</th>
                        <th>gg</th>
                    </tr>
                    </tbody>
                </table>-->
                <table class="orderList">
                    <tr th:each="OrderListDTO, loop : ${pageResponseDTO.dtoList}">
                        <td class="orderListTd">
                            <div class="accordion myAccordion">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <span class="accordion-button" data-bs-toggle="collapse" th:data-bs-target="'panel'+${loop}" aria-expanded="true" aria-controls="panelsStayOpen-collapseOne" onclick="accordionControl(this)">
                                            <span th:text="${OrderListDTO.orderItemDTO.ordItemno}"></span>
                                            <span th:text="${OrderListDTO.productDTO.prodNo}"></span>
                                            <span th:text="${OrderListDTO.productDTO.prodName}"></span>
                                            <span th:text="${#temporals.format(OrderListDTO.orderItemDTO.ordDate, 'yyyy-MM-dd')}"></span>
                                            <span th:if="${OrderListDTO.orderItemDTO.ordStatus == '배송준비'}" style="color: #d10e49" th:text="${OrderListDTO.orderItemDTO.ordStatus}" onclick="changeStatus()"></span>
                                            <span th:if="${OrderListDTO.orderItemDTO.ordStatus == '배송중'}" style="color: #ea5514" th:text="${OrderListDTO.orderItemDTO.ordStatus}" onclick="changeStatus()"></span>
                                            <span th:if="${OrderListDTO.orderItemDTO.ordStatus == '배송완료'}" style="color: #e8bf18" th:text="${OrderListDTO.orderItemDTO.ordStatus}" onclick="changeStatus()"></span>
                                            <span th:if="${OrderListDTO.orderItemDTO.ordStatus == '주문취소'}" style="color: #0ca03c" th:text="${OrderListDTO.orderItemDTO.ordStatus}" onclick="changeStatus()"></span>
                                            <span th:if="${OrderListDTO.orderItemDTO.ordStatus == '교환요청'}" style="color: #1e3fe3" th:text="${OrderListDTO.orderItemDTO.ordStatus}" onclick="changeStatus()"></span>
                                            <span th:if="${OrderListDTO.orderItemDTO.ordStatus == '환불요청'}" style="color: #161875" th:text="${OrderListDTO.orderItemDTO.ordStatus}" onclick="changeStatus()"></span>
                                            <span th:if="${OrderListDTO.orderItemDTO.ordStatus == '요청처리완료'}" style="color: #bd0df4" th:text="${OrderListDTO.orderItemDTO.ordStatus}" onclick="changeStatus()"></span>
                                        </span>
                                    </h2>
                                    <div th:id="'panel'+${loop}" class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            <div>
                                                <div class="details" th:if="${OrderListDTO.optionDTO != null}">
                                                        <p class="productDetail">옵션</p>
                                                    <div class="optionDiv">
                                                        <ul class="list-group">
                                                            <li class="list-group-item">
                                                                <span>옵션번호</span>
                                                                <span th:text="${OrderListDTO.optionDTO.opNo}"></span>
                                                            </li>
                                                            <li class="list-group-item">
                                                                <span>옵션이름</span>
                                                                <span th:text="${OrderListDTO.optionDTO.opName}"></span>
                                                            </li>
                                                            <li class="list-group-item">
                                                                <span>옵션값</span>
                                                                <span th:text="${OrderListDTO.optionDTO.opValue}"></span>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                                <div class="details" th:if="${OrderListDTO.optionDTO == null}">
                                                    <p class="productDetail">옵션</p>
                                                    <img th:src="@{/admin/images/Empty-cuate.png}" style="width: auto; height: 200px">
                                                </div>
                                                <div class="cartPrice order-3">
                                                    <p class="productDetail">주문상세</p>
                                                    <ul class="list-group">
                                                        <li class="list-group-item">
                                                            <span>가격</span>
                                                            <span>[[${OrderListDTO.productDTO.price}]] 원</span>
                                                        </li>
                                                        <li class="list-group-item">
                                                            <span>총 가격</span>
                                                            <span>[[${OrderListDTO.orderItemDTO.count * OrderListDTO.productDTO.price}]] 원</span>
                                                        </li>
                                                        <li class="list-group-item">
                                                            <span>배송받는 분</span>
                                                            <span th:text="${OrderListDTO.orderDTO.recipName}"></span>
                                                        </li>
                                                        <li class="list-group-item">
                                                            <span>전화번호</span>
                                                            <span th:text="${OrderListDTO.orderDTO.recipHp}"></span>
                                                        </li>
                                                        <li class="list-group-item">
                                                            <span>배송지 우편번호</span>
                                                            <span th:text="${OrderListDTO.orderDTO.recipZip}"></span>
                                                        </li>
                                                        <li class="list-group-item">
                                                            <span>배송지 주소</span>
                                                            <span th:text="${OrderListDTO.orderDTO.recipAddr1}"></span>
                                                        </li>
                                                        <li class="list-group-item">
                                                            <span>배송지 상세주소</span>
                                                            <span th:text="${OrderListDTO.orderDTO.recipAddr2}"></span>
                                                        </li>
                                                        <li class="list-group-item">
                                                            <span>주문상태</span>
                                                            <span th:text="${OrderListDTO.orderItemDTO.ordStatus}"></span>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
                <div class="paging" th:if="${!pageResponseDTO.dtoList.isEmpty()}">
                        <span class="prev">
                            <a th:if="${pageResponseDTO.keyword == null}" class="page-link" th:href="@{/seller/order/list(pg=${pageResponseDTO.start - 1})}">&#60;</a>
                            <a th:if="${pageResponseDTO.keyword != null}" class="page-link" th:href="@{/seller/order/list(pg=${pageResponseDTO.start - 1}, type=${pageResponseDTO.type}, keyword=${pageResponseDTO.keyword})}">&#60;</a>
                        </span>
                    <span class="num">
                            <th:block th:each="num:${#numbers.sequence(pageResponseDTO.start, pageResponseDTO.end)}">
                                <a  th:if="${pageResponseDTO.keyword == null}" th:classappend="${pageResponseDTO.pg == num} ? 'page-link on' : 'page-link'" th:href="@{/seller/order/list(pg=${num})}">
                                    [[${num}]]
                                </a>
                                <a  th:if="${pageResponseDTO.keyword != null}" th:classappend="${pageResponseDTO.pg == num} ? 'page-link on' : 'page-link'" th:href="@{/seller/order/list(pg=${num}, type=${pageResponseDTO.type}, keyword=${pageResponseDTO.keyword})}">
                                    [[${num}]]
                                </a>
                            </th:block>
                        </span>
                    <span class="next">
                            <a th:if="${pageResponseDTO.keyword == null}" class="page-link" th:href="@{/seller/order/list(pg=${pageResponseDTO.end + 1})}">&#62;</a>
                            <a th:if="${pageResponseDTO.keyword != null}" class="page-link" th:href="@{/seller/order/list(pg=${pageResponseDTO.end + 1}, type=${pageResponseDTO.type}, keyword=${pageResponseDTO.keyword})}">&#62;</a>
                        </span>
                </div>
                <div class="statusModal modal" id="statusModal">
                    <span class="close" onclick="closeModal()">&times;</span>
                    <div id="btnStatusModal">
                    <span class="btnOrdStatus">배송중</span>
                    <span class="btnOrdStatus">배송중</span>
                    <span class="btnOrdStatus">배송중</span>
                    <span class="btnOrdStatus">배송중</span>
                    <span class="btnOrdStatus">배송중</span>
                    </div>
                </div>
            </section>
